name: Daily Data Report

on:
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 (åŒ—äº¬æ—¶é—´ 08:00)
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    # âœ… å…³é”®ï¼šå£°æ˜å†™å…¥æƒé™ï¼ˆä½¿ git push ç”Ÿæ•ˆï¼‰
    permissions:
      contents: write
    
    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆå¯ç”¨å†™æƒé™ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # âœ… å…³é”®ä¿®å¤ï¼šä½¿ç”¨å®˜æ–¹ pnpm å®‰è£…å™¨
      - name: Setup pnpm
        uses: pnpm/action-setup@v2  # å®˜æ–¹ç»´æŠ¤çš„ Action
        with:
          version: 8  # æŒ‡å®šç¨³å®šç‰ˆæœ¬
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'  # å¯ç”¨ pnpm ä¸“å±ç¼“å­˜
          # âœ… å®‰å…¨å¤„ç† lockfile ä¸å­˜åœ¨çš„æƒ…å†µ
          cache-dependency-path: |
            pnpm-lock.yaml
            package.json
            
      # ğŸ” å…³é”®è¯Šæ–­æ­¥éª¤ (ç«‹å³å¤±è´¥å¹¶æç¤º)
      - name: Verify lockfile
        run: |
          if [ ! -f pnpm-lock.yaml ]; then
            echo "âŒ CRITICAL ERROR: pnpm-lock.yaml is missing!"
            echo "FIX STEPS:"
            echo "1. Run 'pnpm install' locally"
            echo "2. Check your .gitignore does NOT contain 'pnpm-lock.yaml'"
            echo "3. Commit and push the file:"
            echo "   git add pnpm-lock.yaml"
            echo "   git commit -m 'chore: add lockfile'"
            echo "   git push"
            exit 1
          fi
          echo "âœ… Found pnpm-lock.yaml (size: $(du -h pnpm-lock.yaml))"
      
      # 4. å®‰è£…ä¾èµ–ï¼ˆpnpm ç‰ˆï¼‰
      - name: Install dependencies
        run: pnpm install --frozen-lockfile  # âœ… ç›¸å½“äº npm ci
      
      # 5. ç”ŸæˆæŠ¥å‘Šï¼ˆpnpm ç‰ˆï¼‰
      - name: Generate report
        run: |
          pnpm build    # âœ… æ›¿æ¢ä¸ºå®é™…æ„å»ºå‘½ä»¤ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
          pnpm start # âœ… æ›¿æ¢ä¸º package.json ä¸­å®šä¹‰çš„ç”Ÿæˆå‘½ä»¤
      
      # 6. æäº¤æŠ¥å‘Š
      - name: Commit and push report
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          # æ™ºèƒ½æäº¤ï¼šä»…æäº¤å˜æ›´æ–‡ä»¶
          git add -A
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi
          
          git commit -m "chore: update daily report $(date +'%Y-%m-%d')"
          git push
